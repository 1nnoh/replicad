{"version":3,"file":"replicad-threejs-helper.js","sources":["../../lib/replicad-threejs-helper.ts"],"sourcesContent":["import { BufferGeometry, Float32BufferAttribute, EdgesGeometry } from \"three\";\n\nexport interface ReplicadMeshedFaces {\n  vertices: number[];\n  triangles: number[];\n  normals?: number[];\n  faceGroups?: { start: number; count: number; faceId: number }[];\n}\n\nexport interface ReplicadMeshedEdges {\n  lines: number[];\n  edgeGroups?: { start: number; count: number; edgeId: number }[];\n}\n\nexport interface ReplicadMesh {\n  name?: string;\n  faces: ReplicadMeshedFaces;\n  edges?: ReplicadMeshedEdges;\n}\n\nexport interface ThreeGeometry {\n  faces: BufferGeometry;\n  lines: BufferGeometry;\n}\n\n/**\n * Create or update a set of threejs geometries from some meshed edges and\n * faces from replicad\n */\nexport function syncGeometries(\n  replicadMeshes: ReplicadMesh[],\n  inputGeometries: ThreeGeometry[] = []\n): ThreeGeometry[] {\n  let geometries = inputGeometries;\n  if (inputGeometries.length !== replicadMeshes.length) {\n    inputGeometries.forEach(({ lines, faces }) => {\n      faces.dispose();\n      lines.dispose();\n    });\n    geometries = replicadMeshes.map(({ name }) => ({\n      name,\n      faces: new BufferGeometry(),\n      lines: new BufferGeometry(),\n    }));\n  }\n\n  geometries.forEach(({ faces, lines }, i) => {\n    syncFaces(faces, replicadMeshes[i].faces);\n    syncLines(lines, replicadMeshes[i].edges, faces);\n  });\n\n  return geometries;\n}\n\n/**\n * Update a threejs BufferGeometry from some meshed faces from replicad.\n */\nexport function syncFaces(\n  faces: BufferGeometry,\n  replicadMesh: ReplicadMeshedFaces,\n  highlight?: number[]\n): void {\n  faces.clearGroups();\n  delete faces.userData.faceGroups;\n  faces.setIndex(replicadMesh.triangles);\n  faces.setAttribute(\n    \"position\",\n    new Float32BufferAttribute(replicadMesh.vertices, 3)\n  );\n\n  // If you want to change the way colors are applied to different faces you\n  // can change the following code. The group id will correspond to the index\n  // of the materials you link to the mesh of this geometry\n  //\n  // This only works with two materials, the standard one, and the highlight\n  // one.\n  if (replicadMesh.faceGroups) {\n    let shouldHighlight = new Set();\n    if (highlight) {\n      shouldHighlight = new Set(highlight);\n    }\n    faces.userData.faceGroups = replicadMesh.faceGroups;\n    replicadMesh.faceGroups.forEach(({ start, count, faceId }) => {\n      faces.addGroup(start, count, shouldHighlight.has(faceId) ? 1 : 0);\n    });\n  } else {\n    faces.addGroup(0, replicadMesh.triangles.length, 0);\n  }\n\n  if (replicadMesh.normals && replicadMesh.normals.length) {\n    faces.setAttribute(\n      \"normal\",\n      new Float32BufferAttribute(replicadMesh.normals, 3)\n    );\n  } else {\n    faces.computeVertexNormals();\n  }\n\n  faces.computeBoundingBox();\n}\n\n/**\n * Update a threejs BufferGeometry from meshed edges from replicad.\n */\nexport function syncLines(\n  lines: BufferGeometry,\n  edges: ReplicadMeshedEdges | undefined,\n  shapeGeometry: BufferGeometry,\n  highlight?: number[]\n): void {\n  lines.clearGroups();\n  delete lines.userData.edgeGroups;\n\n  if (edges && edges.lines.length) {\n    lines.setAttribute(\"position\", new Float32BufferAttribute(edges.lines, 3));\n  } else {\n    lines.copy(new EdgesGeometry(shapeGeometry, 2));\n  }\n\n  if (!edges) return;\n  if (edges.edgeGroups) {\n    let shouldHighlight = new Set();\n    if (highlight) {\n      shouldHighlight = new Set(highlight);\n    }\n    lines.userData.edgeGroups = edges.edgeGroups;\n    edges.edgeGroups.forEach(({ start, count, edgeId }) => {\n      lines.addGroup(start, count, shouldHighlight.has(edgeId) ? 1 : 0);\n    });\n  } else {\n    lines.addGroup(0, edges.lines.length / 3, 0);\n  }\n}\n\nconst groupFinder =\n  (faceIndex: number) =>\n  ({ start, count }: { start: number; count: number }) => {\n    return faceIndex >= start && faceIndex < start + count;\n  };\n\n/**\n * Changes the material used to represent a certain face or edge by the index\n * of its group\n */\nexport function toggleHighlight(\n  groupIndex: number,\n  geometry: BufferGeometry\n): void {\n  const group = geometry.groups.find(groupFinder(groupIndex));\n  if (group) {\n    group.materialIndex = group.materialIndex ? 0 : 1;\n    // @ts-expect-error types not up to date\n    geometry.groupsNeedUpdate = true;\n  }\n}\n\n/**\n * Set all the materials used to the default one.\n */\nexport function clearHighlights(geometry: BufferGeometry): void {\n  geometry.groups.forEach((g) => {\n    if (g.materialIndex !== 0) {\n      // @ts-expect-error types not up to date\n      geometry.groupsNeedUpdate = true;\n      g.materialIndex = 0;\n    }\n  });\n}\n\n/**\n * Make sure that the elements highlighted in the geometry are only the ones in\n * the elements param.\n */\nexport function highlightInGeometry(\n  elements: number[],\n  geometry: ThreeGeometry\n): void {\n  const groupIndices = new Set(elements);\n\n  // @ts-expect-error types not up to date\n  geometry.groups.forEach(\n    (group: { materialIndex: number }, groupIndex: number) => {\n      const shouldHighlight = groupIndices.has(groupIndex);\n      const isHighlighted = group.materialIndex === 1;\n      if (shouldHighlight === isHighlighted) return;\n\n      group.materialIndex = shouldHighlight ? 1 : 0;\n\n      // @ts-expect-error types not up to date\n      geometry.groupsNeedUpdate = true;\n    }\n  );\n}\n\nexport function getFaceId(faceIndex: number, geometry: BufferGeometry): number {\n  const { faceId } =\n    geometry.userData.faceGroups.find(groupFinder(faceIndex * 3)) || {};\n  return faceId;\n}\n\nexport function getEdgeId(edgeIndex: number, geometry: BufferGeometry): number {\n  const { edgeId } =\n    geometry.userData.edgeGroups.find(groupFinder(edgeIndex)) || {};\n  return edgeId;\n}\n\nexport function getFaceIndex(\n  faceIndex: number,\n  geometry: BufferGeometry\n): number {\n  return geometry.groups.findIndex(groupFinder(faceIndex * 3));\n}\n\nexport function getEdgeIndex(\n  edgeIndex: number,\n  geometry: BufferGeometry\n): number {\n  return geometry.groups.findIndex(groupFinder(edgeIndex));\n}\n"],"names":[],"mappings":"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"}